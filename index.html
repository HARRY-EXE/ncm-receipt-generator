<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nepal Can Move Label</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f2f2f2;
  }

  .pdf-button {
    margin-bottom: 20px;
    padding: 12px 24px;
    background-color: #0066cc;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }

  .pdf-button:hover {
    background-color: #0052a3;
  }

  .pdf-button:active {
    background-color: #004080;
  }

  .pdf-button:disabled {
    background-color: #999;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .label {
    width: 420px;
    background: #fff;
    border: 2px solid #000;
    padding: 10px;
    box-sizing: border-box;
  }

  .header {
    display: flex;
    justify-content: space-between;
    border-bottom: 2px solid #000;
    padding-bottom: 5px;
    font-weight: bold;
  }

  .barcode {
    text-align: center;
    margin: 10px 0;
  }

  .barcode canvas {
    width: 100%;
    height: 60px;
  }

  .logo-section {
    text-align: center;
    border: 1px solid #000;
    padding: 10px;
    box-sizing: border-box;
  }

  .logo-section img {
    width: 245px;
    max-width: 100%;
    height: auto;
  }

  .details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border: 1px solid #000;
    border-top: none;
    box-sizing: border-box;
  }

  .details div {
    border: 1px solid #000;
    text-align: center;
    padding: 5px;
    font-size: 13px;
    font-weight: bold;
    box-sizing: border-box;
  }

  .order-info {
    border: 1px solid #000;
    text-align: center;
    padding: 5px;
    font-size: 13px;
    box-sizing: border-box;
  }

  .bottom {
    display: flex;
    justify-content: space-between;
    border-top: 1px solid #000;
    padding-top: 5px;
    font-size: 12px;
  }

  /* Address + QR layout */
  .info-qr-section {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
  }

  .address-container {
    width: 65%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 5px;
  }

  .address-block {
    border: 1px solid #000;
    padding: 5px;
    font-size: 12px;
    box-sizing: border-box;
  }

  .address-block[contenteditable="true"]:focus {
    outline: 2px solid #0066cc;
    background-color: #f0f8ff;
  }

  .address-block p {
    margin: 2px 0;
  }

  .qr-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 30%;
    border: 1px solid #000;
    padding: 5px;
    gap: 10px;
    box-sizing: border-box;
  }

  .qr-left #footer-qr {
    width: 100px;
    height: 100px;
  }

  .qr-left .signature-img {
    width: 80px;
    height: auto;
  }

  /* Editable elements styling */
  [contenteditable="true"] {
    outline: 1px dashed #999;
    min-height: 1em;
  }

  [contenteditable="true"]:focus {
    outline: 2px solid #0066cc;
    background-color: #f0f8ff;
  }

  input.editable-input {
    border: 1px dashed #999;
    background: transparent;
    padding: 2px 4px;
    font-size: inherit;
    font-family: inherit;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
  }

  input.editable-input:focus {
    outline: 2px solid #0066cc;
    background-color: #f0f8ff;
    border: 1px solid #0066cc;
  }

  input.editable-input[type="text"] {
    border: none;
    border-bottom: 1px dashed #999;
    border-radius: 0;
  }

  input.editable-input[type="text"]:focus {
    border-bottom: 2px solid #0066cc;
  }

  input.editable-input[type="date"] {
    border: 1px dashed #999;
    padding: 1px 2px;
  }

  .editable {
    cursor: text;
  }

  .header [contenteditable="true"],
  .details [contenteditable="true"] {
    display: inline-block;
    min-width: 50px;
  }

  /* Hide PDF button during generation */
  .generating-pdf ~ .pdf-button,
  body.generating-pdf .pdf-button {
    display: none !important;
  }

  /* Preserve borders during PDF generation */
  .generating-pdf {
    box-sizing: border-box !important;
  }

  .generating-pdf * {
    box-sizing: border-box !important;
  }

  /* Hide editable outlines when generating PDF, but preserve actual borders */
  .generating-pdf [contenteditable="true"] {
    outline: none !important;
    background: transparent !important;
  }

  .generating-pdf input.editable-input {
    outline: none !important;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid transparent !important;
  }

  .generating-pdf input.editable-input[type="text"] {
    border-bottom: none !important;
  }

  .generating-pdf input.editable-input[type="date"] {
    border: none !important;
  }

  .generating-pdf .address-block[contenteditable="true"]:focus {
    outline: none !important;
    background-color: transparent !important;
  }

  /* Ensure borders are visible and crisp - preserve original border widths */
  .generating-pdf .label {
    border: 2px solid #000 !important;
  }
  
  .generating-pdf .logo-section,
  .generating-pdf .details,
  .generating-pdf .details div,
  .generating-pdf .order-info,
  .generating-pdf .address-block,
  .generating-pdf .qr-left {
    border: 1px solid #000 !important;
  }
  
  .generating-pdf .header {
    border-bottom: 2px solid #000 !important;
  }
  
  .generating-pdf .details {
    border-top: none !important;
  }
  
  .generating-pdf .bottom {
    border-top: 1px solid #000 !important;
  }
</style>
</head>
<body>

<button class="pdf-button" id="share-pdf-btn">Share as PDF</button>

<div class="label" id="label-content">
  <div class="header">
    <div contenteditable="true">Sales_order</div>
    <div contenteditable="true">marketplace</div>
  </div>

  <div class="barcode">
    <canvas id="barcode"></canvas>
  </div>

  <div class="logo-section">
    <img src="logo.png" alt="Logo">
  </div>

  <div class="details">
    <div contenteditable="true">STANDARD</div>
    <div contenteditable="true">1.0 KG</div>
    <div contenteditable="true">WORK</div>
    <div contenteditable="true">PREPAYMENT</div>
    <div contenteditable="true">NRS : </div>
    <div contenteditable="true">COD : 00</div>
  </div>

  <div class="order-info">
    <p><strong>Order Number:</strong> <input type="text" id="order-number" class="editable-input" maxlength="16" style="width: 200px; text-align: center;"></p>
    <div class="bottom">
      <span>Order Creation Date: <input type="text" id="order-date" class="editable-input" style="width: 120px; text-align: center;"></span>
      <span>AWB Print Date: <input type="date" id="awb-date" class="editable-input" style="width: 130px;"></span>
    </div>
  </div>

  <div class="info-qr-section">
    <div class="qr-left">
      <img id="footer-qr" src="" alt="QR Code">
      <img src="sign.png" class="signature-img" alt="Signature">
    </div>

    <div class="address-container">
      <div class="address-block" contenteditable="true">
        <strong>Receiver</strong><br>
        Receiver Name<br>
        Address 1<br>
        Address 2<br>
        Address 3<br>
        Phone: +977 9000000000
      </div>
      <div class="address-block" contenteditable="true">
        <strong>Sender</strong><br>
        Evans Clothing Co.<br>
        Dharan Line,<br>
        Itahari<br>
        Phone: +977 9700462618
      </div>
    </div>
  </div>
</div>

<!-- JsBarcode for barcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<!-- html2pdf.js for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  // Generate random 16-digit order number
  function generateOrderNumber() {
    let orderNumber = '';
    for (let i = 0; i < 16; i++) {
      orderNumber += Math.floor(Math.random() * 10);
    }
    return orderNumber;
  }

  // Function to update barcode
  function updateBarcode(orderNumber) {
    if (orderNumber && orderNumber.length > 0) {
      try {
        JsBarcode("#barcode", orderNumber, {
          format: "CODE128",
          displayValue: false,
          lineColor: "#000",
          width: 2,
          height: 60
        });
      } catch (e) {
        console.error("Error generating barcode:", e);
      }
    }
  }

  // Initialize order number
  const orderNumber = generateOrderNumber();
  const orderNumberInput = document.getElementById('order-number');
  orderNumberInput.value = orderNumber;

  // Update barcode when order number changes
  orderNumberInput.addEventListener('input', function() {
    updateBarcode(this.value);
  });

  // Create initial barcode
  updateBarcode(orderNumber);

  // Set today's date for Order Creation and AWB dates
  const today = new Date();
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const day = today.getDate();
  const month = months[today.getMonth()];
  const year = today.getFullYear();
  document.getElementById('order-date').value = `${day} ${month} ${year}`;
  document.getElementById('awb-date').value = today.toISOString().split('T')[0];

  // Generate QR Code linking to the website
  const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://www.nepalcanmove.com/`;
  document.getElementById('footer-qr').src = qrURL;

  // Function to extract receiver name from address block
  function getReceiverName() {
    const addressBlocks = document.querySelectorAll('.address-block[contenteditable="true"]');
    for (let block of addressBlocks) {
      const text = block.innerText || block.textContent;
      const lines = text.split('\n').filter(line => line.trim());
      // Check if this is the receiver block (first line should be "Receiver")
      if (lines.length > 0 && lines[0].trim().toLowerCase().includes('receiver')) {
        // The receiver name should be after "Receiver" header
        if (lines.length > 1) {
          return lines[1].trim(); // Second line after "Receiver"
        }
      }
    }
    return 'Receiver'; // Default fallback
  }

  // Function to sanitize filename (remove invalid characters)
  function sanitizeFileName(name) {
    // Replace spaces and special characters with dashes, keep only alphanumeric and dashes
    return name.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 50);
  }

  // Function to generate PDF
  async function generatePDF() {
    const button = document.getElementById('share-pdf-btn');
    const originalText = button.textContent;
    
    try {
      // Disable button during generation
      button.disabled = true;
      button.textContent = 'Generating PDF...';

      // Get receiver name and order ID
      const receiverName = getReceiverName();
      const orderId = document.getElementById('order-number').value || '0000000000000000';
      
      // Sanitize receiver name for filename
      const sanitizedName = sanitizeFileName(receiverName);
      
      // Generate filename: NCM-{receivername}-{orderid}.pdf
      const filename = `NCM-${sanitizedName}-${orderId}.pdf`;

      // Get the label content element
      const element = document.getElementById('label-content');
      
      // Temporarily hide editable outlines by adding a class
      element.classList.add('generating-pdf');
      
      // Wait a moment for styles to apply and ensure layout is stable
      await new Promise(requestAnimationFrame);
      await new Promise(resolve => setTimeout(resolve, 100));
      element.offsetHeight; // force reflow
      
      // Determine device scale for sharper rendering on mobile devices
      const deviceScale = Math.min(3, Math.max(1.5, window.devicePixelRatio || 1));
      
      // Use the element's intrinsic dimensions (includes padding & border)
      const width = element.offsetWidth;
      const height = element.offsetHeight;
      
      // Convert pixels to millimetres (96 px = 25.4 mm)
      const pxToMm = 25.4 / 96;
      const widthMM = width * pxToMm;
      const heightMM = height * pxToMm;
      
      // Add a small safety margin so borders are not clipped
      const margin = 3;
      const pageWidth = widthMM + margin * 2;
      const pageHeight = heightMM + margin * 2;
      
      // Configure PDF options - match page size exactly to label dimensions
      const opt = {
        margin: [margin, margin, margin, margin],
        filename: filename,
        image: { type: 'png', quality: 1.0 },
        html2canvas: { 
          scale: deviceScale,
          useCORS: true,
          allowTaint: false,
          logging: false,
          letterRendering: false,
          backgroundColor: '#ffffff',
          width: width,
          height: height,
          windowWidth: width,
          windowHeight: height,
          x: 0,
          y: 0,
          scrollX: -window.scrollX,
          scrollY: -window.scrollY,
          removeContainer: true,
          foreignObjectRendering: false
        },
        jsPDF: { 
          unit: 'mm', 
          format: [pageWidth, pageHeight],
          orientation: pageWidth > pageHeight ? 'landscape' : 'portrait',
          compress: true,
          precision: 16
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      
      // Generate and download PDF (ensuring we only keep the first page)
      const worker = html2pdf().set(opt).from(element).toPdf();
      const pdf = await worker.get('pdf');
      const totalPages = pdf.internal.getNumberOfPages();
      if (totalPages > 1) {
        for (let i = totalPages; i > 1; i--) {
          pdf.deletePage(i);
        }
      }
      await worker.save();
      
      // Remove the class after PDF generation
      element.classList.remove('generating-pdf');
      
      button.textContent = 'PDF Generated!';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    } catch (error) {
      console.error('Error generating PDF:', error);
      document.getElementById('label-content').classList.remove('generating-pdf');
      button.textContent = 'Error generating PDF';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    } finally {
      button.disabled = false;
    }
  }

  // Attach event listener to PDF button
  document.getElementById('share-pdf-btn').addEventListener('click', generatePDF);
</script>

</body>
</html>
